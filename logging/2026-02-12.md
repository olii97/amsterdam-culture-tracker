# Session log — 12 February 2026

Summary of what we did today on the Amsterdam Culture Tracker project.

---

## 1. SwiftUI implementation plan (iOS)

- Updated **`ios/README.md`** with a concrete SwiftUI implementation plan:
  - Phase 0: Model/schema parity (UUID, venue_type, museumkaart, exhibitions, saved_events)
  - Phase 1: Map + visit loop
  - Phase 2: Discovery (events, museums, "Surprise me")
  - Phase 3: Nudge layer (weekly digest, "ending soon")
  - Phase 4: Stats, Museumkaart ROI
- Added an ordered Xcode backlog and practical build rules.

---

## 2. Schema parity (SQL → iOS)

- **Venue model** (`Venue.swift`): added `venue_type`, `museumkaart`, and `VenueType` enum.
- **New models**: `Exhibition.swift`, `SavedEvent.swift` (matching Supabase `exhibitions` and `saved_events`).
- **SupabaseService**: added `fetchMuseums()`, `fetchMuseumkaartVenues()`, `fetchEndingSoonExhibitions(withinDays:)`, `fetchExhibitionsForVenue(venueId:)`, `fetchSavedEvents()`, `saveEvent(eventId:)`, `unsaveEvent(eventId:)`.

---

## 3. Wiring new services in the app

- **VenueMapView**: filter (All / Museums / Museumkaart), different pin tint for museums.
- **EventDetailView**: Save/Unsave event button, loads saved state from `saved_events`.
- **VenueDetailView**: "Exhibitions" section with end date and "Ending soon" badge (14-day window).

---

## 4. Saved tab + new events (unseen) flow

- **SavedEventsView**: new tab listing bookmarked events, swipe to unsave.
- **NewEventsTracker** (`NewEventsTracker.swift`): `lastSeenAt` in UserDefaults, unseen count, `markAllSeen()`.
- **Events tab**: badge with unseen count (when > 0), "New only" toggle, "Mark Seen" button.
- **AmsterdamCultureTrackerApp**: injects `NewEventsTracker`, refreshes unseen count on launch.
- **Fix**: `import Combine` in `NewEventsTracker` for `ObservableObject` / `@Published`.
- **Fix**: Events tab badge — conditional tab (show `.badge(count)` only when count > 0) to satisfy `Int` (non-optional) API.

---

## 5. Daily scraper deployment + run logging

- **GitHub Actions**: added `.github/workflows/daily-scrape.yml` — scheduled daily (04:00 UTC), runs `python -m cultural_venues_scraper.scrape_all`, uses `SUPABASE_URL` and `SUPABASE_KEY` secrets.
- **Scraper run logging**:
  - **Schema**: `scraper_runs` table in `schema.sql` and `migrations/002_scraper_runs.sql` (source, status, started_at, finished_at, total_scraped, parsed_rows, skipped_unparseable_dates, new_events_estimated, error_message).
  - **supabase_writer.py**: creates a run row at start, estimates new events before upsert, marks run completed/failed with stats.
- **Docs**: `cultural_venues_scraper/README.md` — how to add GitHub Actions secrets and run the workflow.

---

## 6. Scraper fixes

- **Duplicate key error**: "ON CONFLICT DO UPDATE command cannot affect row a second time" — deduplicated rows by `(event_title, event_date)` before upsert in `supabase_writer.py`; log when rows are deduped.

---

## 7. iPhone deployment + environment

- **Deploy to device**: steps for signing (Team, Bundle ID), selecting device, Run; trust developer in Settings → Device Management; Developer Mode if required.
- **Venv**: clarified that activating the venv is `source venv/bin/activate` (not executing `venv/bin/activate`).
- **DerivedData / "no space left"**: Xcode "Couldn't create workspace arena folder" and zsh history lock failures were caused by full disk; guidance to free space (Trash, Xcode DerivedData/caches, other caches, iOS backups).
- **Where the build is**: simulator build in DerivedData `…/Debug-iphonesimulator/AmsterdamCultureTracker.app`; device build is on the iPhone home screen / App Library.

---

## 8. Testing

- Scraper run confirmed: 6 venues, 748 combined events, 306 upserted after dedup, 422 skipped (unparseable dates). Paradiso and others now contributing.

---

## Files touched (summary)

| Area     | Files |
|----------|--------|
| iOS      | `AmsterdamCultureTrackerApp.swift`, `NewEventsTracker.swift`, `EventsListView.swift`, `EventDetailView.swift`, `VenueDetailView.swift`, `VenueMapView.swift`, `SupabaseService.swift`, `Venue.swift`; new: `Exhibition.swift`, `SavedEvent.swift`, `SavedEventsView.swift` |
| Scraper  | `supabase_writer.py` (dedup, scraper_runs logging) |
| Schema   | `schema.sql`, `migrations/002_scraper_runs.sql` |
| CI/docs  | `.github/workflows/daily-scrape.yml`, `cultural_venues_scraper/README.md`, `ios/README.md` |
